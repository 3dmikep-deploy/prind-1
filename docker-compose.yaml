version: '3.4'

services:

  klipper:
    image: klipper:latest
    build:
      args:
        VERSION: 319c36df52eb016667d13ab006cae3752d0212e7
      dockerfile: klipper.Dockerfile
      context: dockerfiles/
      target: run
    container_name: klipper
    restart: unless-stopped
    privileged: true
    volumes:
      - /dev:/dev
      - run:/opt/run
      - gcode:/opt/gcode
      - ./config:/opt/cfg

  octoprint:
    image: octoprint/octoprint:1-minimal
    container_name: octoprint
    restart: unless-stopped
    depends_on:
      - klipper
      - ustreamer
      - traefik
    privileged: true
    ports:
      - 5000:5000
    volumes:
      - /dev:/dev
      - run:/opt/run
      - octoprint:/octoprint
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.octoprint.loadbalancer.server.port=5000'
      - 'traefik.http.routers.octoprint.rule=PathPrefix(`/`)'
      - 'traefik.http.routers.octoprint.entrypoints=web'

#  moonraker:
#    image: moonraker:latest
#    build:
#      dockerfile: moonraker.Dockerfile
#      context: dockerfiles/
#      target: run
#    container_name: moonraker
#    restart: unless-stopped
#    depends_on:
#      - klipper
#    volumes:
#      - ./config:/opt/cfg
#      - run:/opt/run
#      - gcode:/opt/gcode
#      - db:/opt/db
#    ports:
#      - 7125:7125
#    ## Fluidd won't connect, if moonraker runs under a subdirectory.
#    ## may be enabled in the future
#    #labels:
#    #  - 'traefik.enable=true'
#    #  - 'traefik.http.services.moonraker.loadbalancer.server.port=7125'
#    #  - 'traefik.http.routers.moonraker.rule=PathPrefix(`/moonraker`)'
#    #  - 'traefik.http.routers.moonraker.entrypoints=web'
#    #  - 'traefik.http.routers.moonraker.middlewares=moonraker-stripprefix'
#    #  - 'traefik.http.middlewares.moonraker-stripprefix.stripprefix.prefixes=/moonraker'

#  fluidd:
#    image: cadriel/fluidd:latest
#    container_name: fluidd
#    restart: unless-stopped
#    depends_on:
#      - moonraker
#      - ustreamer
#      - traefik
#    ## Fluidd needs to be the root path https://github.com/cadriel/fluidd/issues/347
#    labels:
#      - 'traefik.enable=true'
#      - 'traefik.http.services.fluidd.loadbalancer.server.port=80'
#      - 'traefik.http.routers.fluidd.rule=PathPrefix(`/`)'
#      - 'traefik.http.routers.fluidd.entrypoints=web'

  ustreamer:
    image: ustreamer:latest
    build:
      dockerfile: ustreamer.Dockerfile
      context: dockerfiles/
      target: run
    container_name: ustreamer
    restart: unless-stopped
    depends_on:
      - traefik
    devices:
      - /dev/video0:/dev/video0
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.ustreamer.loadbalancer.server.port=8080'
      - 'traefik.http.routers.ustreamer.rule=PathPrefix(`/stream`)'
      - 'traefik.http.routers.ustreamer.entrypoints=web'

  traefik:
    image: 'traefik:v2.2'
    container_name: 'traefik'
    hostname: 'traefik'
    command:
      - '--accesslog'
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'
      - '--entrypoints.web.address=:80'
    ports:
      - '80:80'
    restart: unless-stopped
    volumes:
        - '/var/run/docker.sock:/var/run/docker.sock:ro'

volumes:
  db:
  run:
  gcode:
  octoprint:
